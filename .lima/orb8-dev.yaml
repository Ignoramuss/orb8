# Lima VM configuration for orb8 development
# This creates a full Linux environment with eBPF and Kubernetes support

vmType: "qemu"
os: "Linux"
arch: "default"

images:
  - location: "https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-amd64.img"
    arch: "x86_64"
  - location: "https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-arm64.img"
    arch: "aarch64"

cpus: 4
memory: "6GiB"
disk: "20GiB"

mounts:
  - location: "~"
    writable: true

# Enable SSH
ssh:
  loadDotSSHPubKeys: true

# Provision script: Install development tools
provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail

      # Update system
      export DEBIAN_FRONTEND=noninteractive
      apt-get update

      # Install build essentials
      apt-get install -y \
        build-essential \
        curl \
        git \
        pkg-config \
        libssl-dev \
        vim \
        less \
        jq

      # Install eBPF tools and LLVM
      apt-get install -y \
        llvm-14 \
        llvm-14-dev \
        clang-14 \
        libclang-14-dev \
        libbpf-dev \
        linux-headers-generic \
        linux-tools-generic \
        bpftool

      # Install kubectl
      curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | \
        gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /' | \
        tee /etc/apt/sources.list.d/kubernetes.list
      apt-get update
      apt-get install -y kubectl

      # Install Docker (for minikube)
      curl -fsSL https://get.docker.com | sh
      usermod -aG docker {{.User}}

      # Install minikube
      curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
      install minikube-linux-amd64 /usr/local/bin/minikube
      rm minikube-linux-amd64

  - mode: user
    script: |
      #!/bin/bash
      set -eux -o pipefail

      # Install Rust (stable and nightly)
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- \
        -y \
        --default-toolchain stable \
        --profile default \
        -c rustfmt -c clippy -c rust-analyzer

      # Source Rust environment
      source "$HOME/.cargo/env"

      # Install nightly toolchain with rust-src for eBPF
      rustup toolchain install nightly --component rust-src

      # Install aya-specific tools
      cargo install bpf-linker
      cargo install cargo-generate

      # Verify installations
      rustc --version
      rustc +nightly --version
      cargo --version
      bpf-linker --version
      kubectl version --client
      minikube version
      bpftool version

message: |
  ========================================
  orb8 Development Environment Ready!
  ========================================

  The Linux VM is running with:
  - Ubuntu 22.04
  - Rust (stable + nightly with rust-src)
  - bpf-linker (eBPF linker for Rust)
  - cargo-generate (project scaffolding)
  - eBPF tools (LLVM 14, clang, libbpf, bpftool)
  - kubectl
  - minikube
  - Docker

  Your orb8 project is mounted at: {{.Dir}}

  To enter the VM:
    limactl shell orb8-dev

  Or use the shortcut:
    make shell

  Inside the VM, you can:
    cd {{.Dir}}
    cargo build
    cargo test
    cargo run -- --help
